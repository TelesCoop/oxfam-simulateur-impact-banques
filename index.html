<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Oxfam - Empreinte carbone des banques</title>
  <meta name="viewport" content="width=device-width, user-scalable=yes" />
  <meta name="robots" content="noindex">
  <link rel="stylesheet" href="css/min.min.css">
  <link rel="stylesheet" href="css/oxfam.css">
  <link href='https://fonts.googleapis.com/css?family=Lato:400,400,400i,700,700i%7CMontserrat:700,400&subset=cyrillic,cyrillic-ext,devanagari,greek,greek-ext,khmer,latin,latin-ext,vietnamese,hebrew,arabic,bengali,gujarati,tamil,telugu,thai,cyrillic,cyrillic-ext,devanagari,greek,greek-ext,khmer,latin,latin-ext,vietnamese,hebrew,arabic,bengali,gujarati,tamil,telugu,thai' rel='stylesheet' type='text/css'>
  <script src="js/tmpl.min.js"></script>
</head>
<body>
  <div style="margin: auto; margin-top: 10px; min-height: 400px; max-width: 600px; padding: 20px;">
    <div style="display: flex; align-items: center; justify-content: center; min-height: inherit;">
      <!-- SCREEN 1 -->
      <div class='screen' id="screen-1">
        <h1 class="headline">Mon empreinte carbone</h1>
        <h2 style="text-align: center; font-size: 1.9em">
          Je calcule l'impact de mon <br>
          épargne en 10 secondes
        </h2>
        <div style="text-align: center; margin-top: 10px">
          <button class="btn btn-b" onclick="screenTransition(1, 2);">
            démarrer
          </button>
        </div>
      </div>

      <!-- SCREEN 2 -->
      <div class='screen' id="screen-2" style="display: none;"></div>

      <!-- SCREEN 3 -->
      <div class='screen' id="screen-3" style="display: none; opacity: 0;"></div>
    </div>
  </div>

  <!-- TEMPLATE SCREEN 2 -->
  <script type="text/x-tmpl" id="tmpl-screen-2" style="display: none;">
    <div>
      <h1 class="headline">Mon empreinte carbone</h1>
      <label for="amount">
        <h2>Montant de mon épargne</h2>
      </label> <br>
        <input type="text" id="savingsAmount" class="smooth" placeholder="100 000"  oninput="reformatAmount(); checkValuesAreValid()"/><span class="addon">€</span>
    </div>
    <div style="margin-top: 20px">
      <label for="amount">
        <h2>Ma banque</h2>
      </label> <br>
      <select name="bank" id="bank" oninput="checkValuesAreValid()">
        {% for (var i=0; i<o.banks.length; i++) { %}
            <option value="{%=i%}">{%=o.banks[i][0]%}</option>
        {% } %}
      </select>
    </div>
    <div style="text-align: center">
      <button id='screen2-confirm'
              class="btn btn-b"
              onclick="goToScreen3()"
              style="margin-top: 30px">
        OK
      </button>
    </div>
  </script>

  <!-- TEMPLATE SCREEN 3 -->
  <script type="text/x-tmpl" id="tmpl-screen-3" style="display: none;">
    <h1 style="text-align: center; font-size: 1.9em">
      Mon empreinte carbone
    </h1>
    <div style="text-align: center">
      <p class="result">
        <span class='resultAmount'>{%=o.co2ImpactShow%}</span> tonnes éqCO2 par an
      </p>
      <p>
        A titre de comparaison, l'empreinte carbone moyenne annuelle d’un français est de <span class='resultAmount'>11,2</span> tonnes éqCO2 par an.
      </p>
      <p>
        Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. Nunc maximus justo rhoncus dui mollis semper. Praesent porttitor quam enim, id sodales quam pellentesque in. Fusce elementum blandit fermentum. Duis quis sapien turpis. Praesent quis maximus leo, non viverra elit. Vestibulum magna odio, bibendum at orci ut, lacinia luctus ante. Integer iaculis eleifend pulvinar. Fusce feugiat nulla sit amet mauris scelerisque venenatis. Pellentesque ut mi nec sem scelerisque tincidunt.
      </p>
      <p>
        <a href="https://www.oxfamfrance.org/" style="font-weight: 700">En savoir plus</a>.
      </p>
    </div>
    <div style="text-align: center">
      <button class="btn btn-sm" onclick="screenTransition(3, 2)">
        modifier
      </button>
    </div>
  </script>

  <script type="application/javascript">
    function addSpaces(numberStr) {
      if (numberStr.length <= 3) {
        return numberStr;
      }
      if (numberStr.length > 3) {
        return addSpaces(numberStr.substr(0, numberStr.length - 3)) + ' ' + numberStr.substr(numberStr.length - 3);
      }
    }
    function reformatAmount() {
      var amount = document.getElementById('savingsAmount').value;
      console.log('### reformat amount, input=', amount);
      // only keep numbers
      amount = amount.split('').filter(function(letter){return numbers.indexOf(letter) != -1}).join('');
      // add spaces
      amount = addSpaces(amount);
      document.getElementById('savingsAmount').value = amount;
      console.log('### reformat amount, output=', amount);
    }

    // a list of [name, impactCoeff], where impactCoeff in tons Co2eq/€
    var numbers = "0123456789".split('');
    var BANKS = [
      ["Banque Populaire Caisse d'Épargne", 379],
      ["La Banque Postale", 353],
      ['Société Générale', 652],
      ['BNP Paribas', 601],
      ['Crédit Agricole', 444],
    ];
    var bankName = '';
    var co2Impact = 0; // in 0.01.tonnes
    var co2ImpactShow = 0;
    var savingsAmount = 0; // in €
    var bankCoeff = null;

    function showElement(divId) {
      document.getElementById(divId).style.display = 'block';
    }
    function hideElement(divId) {
      document.getElementById(divId).style.display = 'none';
    }
    function showScreen(screenId){
      hideElement('screen-1');
      hideElement('screen-2');
      hideElement('screen-3');
      showElement('screen-' + screenId);
    }
    function screenOpacity(screenId, opacity) {
      document.getElementById('screen-' + screenId).style.opacity = opacity;
    }
    function screenTransition(prevScreenId, nextScreenId){
      screenOpacity(prevScreenId, 0);
      setTimeout(function(){
        hideElement('screen-' + prevScreenId);
        showElement('screen-' + nextScreenId);
        setTimeout(function(){screenOpacity(nextScreenId, 1);}, 200);
        }, 200);
    }
    function areValuesValid(){
      return co2Impact != null;
    }
    function checkValuesAreValid() {
      computeValues();
      var isValid = areValuesValid();
      var confirmBtn = document.getElementById('screen2-confirm');
      confirmBtn.disabled = !isValid;
      if (isValid) {
        confirmBtn.classList.remove('disabled');
      } else {
        confirmBtn.classList.add('disabled');
      }

      console.log("### check values are valid", isValid);

      return isValid;
    }

    function roundCo2Impact(value){
      if (value == null) {
        return;
      }
      if (value > 10) {
        return Math.round(value);
      }
      if (value > 1) {
        return value.toFixed(1);
      }
      if (value > 0.1) {
        return value.toFixed(2);
      }
      if (value > 0.01) {
        return value.toFixed(3);
      }
      if (value > 0.001) {
        return value.toFixed(4);
      }
      if (value > 0.0001) {
        return value.toFixed(5);
      }
      return value.toPrecision(2);
    }

    function computeValues(){
      console.log("### compute values");
      savingsAmount = document.getElementById('savingsAmount').value;
      var bankId = parseInt(document.getElementById('bank').value);
      if (bankId == null) {
        bankName = '';
        bankCoeff = null;
      } else {
        var bank = BANKS[bankId];
        bankName = bank[0];
        bankCoeff = bank[1];
      }
      savingsAmount = document.getElementById('savingsAmount').value;
      if (savingsAmount) {
        savingsAmount = parseFloat(savingsAmount.replace(/\s/g, ''));
      }
      if (savingsAmount && bankCoeff) {
        co2Impact = savingsAmount / 1e6 * bankCoeff;
      } else {
        co2Impact = null;
      }
      co2ImpactShow = roundCo2Impact(co2Impact);

      console.log("### compute values", bankName, bankCoeff, savingsAmount, co2Impact);
    }

    function updateTemplate(screenId) {
      var data = {
        banks: BANKS,
        bankName: bankName,
        co2ImpactShow: co2ImpactShow,
      };

      console.log('### update template', screenId, data);
      document.getElementById('screen-' + screenId).innerHTML = tmpl(
        'tmpl-screen-' + screenId, data
      );
      document.getElementById('screen-' + screenId).innerHTML = tmpl(
        'tmpl-screen-' + screenId, data
      );

      return true;
    }
    function sendNewEntry() {
      function reqListener () {
        console.log('### response sent', this, this.responseText);
      }
      var xhr = new XMLHttpRequest();
      xhr.onload = reqListener;
      xhr.open("get", "/entry", true);
      xhr.send();
    }

    function goToScreen3() {
      if (!checkValuesAreValid()) {
        return false;
      }
      updateTemplate(3);
      sendNewEntry();
      screenTransition(2, 3);
    }

    // executes after html load
    (function() {
      updateTemplate(2);
      showScreen(2);
      screenTransition(2, 2);
      checkValuesAreValid();
    })();
  </script>
</body>
</html>
